# 조인 튜닝

### 연습문제-1

```sql
FROM절에 나열한 주문, 고객, 결제방식 순으로 조인하되, 고객테이블과는 NL 조인, 결제방식과는 해시조인을 유도합니다.

select /*+  ___ */
       o.주문번호, o.고객번호, c.고객명, c.전화번호, o.주문번호, t.결제방식명
  from 주문 o, 고객 c, 결제방식 t
 where o.주문일자 >= trunc(sysdate)
   and c.고객번호 = o.고객번호
   and t.결제방식코드 = o.결제방식코드     

```

- 정답 : ordered use_nl(c) use_hash(t)

### 연습문제 2

```sql
SQL server에서 주문테이블 기준으로 고객 테이블과 NL 조인유도하기

select o.주문번호, o.고객번호, c.고객명, c.전화번호, o.주문금액
  from 주문 o, 고객 c
 where o.주문일자 >= trunc(sysdate)
   and c.고객번호 = o.고객번호
option ( ___ )   

```

- 정답 : force order, loop join


### 연습문제 - 3

```sql
실행되는 순서는?

사원_PK : 사원번호
사원_X1 : 입사일자
고객_PK : 고객번호
고객_X1 : 관리사원번호

select /*+ ordered use_nl(c) index(e) index(c) */
    e.사원번호, e.사원명, e.입사일자
   ,c.고객번호, c.고개명, c.전화번호, c.최종주문금액
  from 사원 e, 고객 c
 where c.관리사원번호 = e.사원번호    ---- (가)
   and e.입사일자 >= '19960101'    ---- (나)
   and e.부서코드 = 'Z123'         ---- (다)
   and c.최종주문금액 >= 20000      ---- (라)
```

- 정답 : 나 -> 다 -> 가 -> 라
- 해설 : 고객테이블 인덱스에 최종주문금액에 인덱스가 있다면,   
`나 -> 다 -> 라 -> 가` 순서로 진행할 수도 있다.


### 연습문제 - 4

```sql
사원_PK : 사원번호
사원_X1 : 입사일자
사원_X2 : 부서코드
고객_PK : 고객번호
고객_X1 : 관리사원번호
고객_X2 : 최종주문금액


select /*+ ordered use_nl(c) index(e) index(c) */
       e.사원번호, e.사원명, e.입사일자,
       c.고객번호, c.고객명, c.전화번호, c.최종주문금액
  from 사원 e, 고객 c
 where c.관리사원번호 = e.사원번호       ----- 가
   and e.입사일자 >= '19960101'      ----- 나
   and e.부서코드 = 'z123'           ----- 다
   and c.최종주문금액 >= 20000        ----- 라

```

- 가능한 순서

`나 -> 다 -> 가 -> 라 (사용인덱스 : 사원_X1, 고객_X1)`  
`나 -> 다 -> 라 -> 가 (사용인덱스 : 사원_X1, 고객_X2)`  
`다 -> 나 -> 가 -> 라 (사용인덱스 : 사원_X2, 고객_X1)`  
`다 -> 나 -> 라 -> 가 (사용인덱스 : 사원_X2, 고객_X2)`


## NL 조인 특징 

NL 조인의 첫 번째 특징은 랜덤 액세스 위주의 조인 방식이라는 점이다.  
인덱스 구성이 아무리 완벽해도 대량 데이터 조인할 때 NL조인이 불리한 이유다.  

두 번째 특징은 조인을 한 레코드씩 순차적으로 진행한다는 점이다. 따라서 부분범위 처리가 가능하다면 조인할 대상 레코드가 아무리 많아도 빠른 응답 속도를 낼 수 있다.  
순차적으로 진행하므로 먼저 액세스되는 테이블 처리 범위에 의해 전체 일량이 결정되는 특징도 나타난다.  

마지막으로, 다른 조인 방식과 비교할 때 인덱스 구성전략이 특히 중요하다는 점도 중요한 특징이다.  
조인 컬럼에 대한 인덱스가 있느냐 없느냐, 있다면 컬럼이 어떻게 구성했느냐에 따라 조인 효율이 크게 달라진다.

종합하면 NL조인은 `소량 데이터를 주로 처리하거나 부분범위 처리가 가능한 트랜잭션 처리(OLTP) 시스템에 적합한 조인 방식이다.`

